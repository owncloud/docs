#!/bin/bash

#
# Prepends the _redirects file, which contains redirects for the old
# documentation to the new documentation, to the _redirects file generated by
# antora, if it exists and is not empty.
# Written by Matthew Setter <matthew@matthewsetter.com>
# Copyright (c) 2018 ownCloud.
#

set -e

REDIRECTS_FILE="public/_redirects"

merge_redirects_file()
{
    cat _redirects "$REDIRECTS_FILE" > /tmp/_redirects
    mv /tmp/_redirects "$REDIRECTS_FILE"
}

if [[ -e "$REDIRECTS_FILE" &&  -w "$REDIRECTS_FILE" ]]
then
    if [  -s "$REDIRECTS_FILE" ]
    then
        # Only merge files if not already merged
        grep --silent -f _redirects < public/_redirects || merge_redirects_file
    else
        cp _redirects "$REDIRECTS_FILE"
    fi;
fi;
