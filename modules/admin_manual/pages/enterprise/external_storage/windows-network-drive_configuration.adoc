= Windows Network Drive (WND)
:toc: right
:toclevels: 3
:anacron-examples: http://www.thegeekstuff.com/2011/05/anacron-examples
:flock-docs-url: https://linux.die.net/man/2/flock
:shell-flock-intro: https://linuxaria.com/howto/linux-shell-introduction-to-flock
:msft-security-bulletin-ms17-010-url: https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010
:samba-478-url: https://www.samba.org/samba/history/samba-4.7.8.html
:samba-481-url: https://www.samba.org/samba/history/samba-4.8.1.html
:samba-url: https://www.samba.org/
:smb2-url: https://en.wikipedia.org/wiki/Server_Message_Block#SMB_2.0
:smbclient-manpage-url: https://www.samba.org/samba/docs/man/manpages-3/smbclient.1.html
:wannacry-ransomware-attack-url: https://en.wikipedia.org/wiki/WannaCry_ransomware_attack
:acl-url: https://en.wikipedia.org/wiki/Access-control_list
:password-lockout-policies-url: https://docs.microsoft.com/en-us/previous-versions/tn-archive/dd277400(v=technet.10)
:manage-systemd-services-url: https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units
:base64-url: https://www.base64decode.org/
:vaultproject-url: https://www.vaultproject.io
:hashicorp-url: https://learn.hashicorp.com/collections/vault/getting-started
:pass-url: http://xmodulo.com/manage-passwords-command-line-linux.html

== Introduction

The {oc-marketplace-url}/apps/windows_network_drive[External Storage: Windows Network Drives app]
creates a control panel in your Admin page for seamlessly integrating Windows and Samba/CIFS shared network
drives as external storages.

Any Windows file share and Samba servers on Linux and other Unix-type operating systems use the SMB/CIFS
file-sharing protocol. The files and directories on the SMB/CIFS server will be visible on your Files page
just like your other ownCloud files and folders.

Compared to standard SMB access, WND has advanced features like:

. User lockout prevention and password reset
. More authentication mechanisms against the backend
. Listen to change information triggered by the backend
. Enhanced ACL support
. Collaborative WND (CWND)

.Brief Description of Advanced Features:

User lockout prevention and password reset::
Depending on the Windows or Samba policy, users could get locked out of their account if they enter a wrong password a number of times. The lockout prevention tries to avoid this from happening by resetting the password if it is wrong. This is also true for Collaborative WND when using `login credentials saved in database` and a repeatedly running files-scan job which may use outdated credentials. In the case of ownCloud's standard SMB connector, the password won't be reset. It could happen that users get locked out of the file server.

More authentication mechanisms against the backend::
Please see the details about the xref:enterprise/external_storage/enterprise_only_auth.adoc[Enterprise-Only Authentication Options]

Listen to change information triggered by the backend::
Native Windows File Servers provide the ability to send change notifications regarding modified files and folders somewhere in a share. Samba can send file notifications as well, as long as all the file actions are performed through the SMB protocol. However, it won't work if the action is performed directly inside the filesystem used by Samba. This mechanism then updates the ownCloud database and provides the changes made to accessing users. Users do not need to manually check for changes in all possible locations of their mount. Changes processed are also propagated to sync clients automatically.

Enhanced ACL support::
With enhanced ACL support, both SMB and WND evaluate the file attributes (whether the file is hidden or read-only) to decide what ownCloud permissions the file or folder should have in ownCloud. On top of this, WND can also evaluate the ACLs by using the `ocLdapPermissionManager` in the mount point configuration. This will bring more accurate permissions to ownCloud, especially when each user can have different permissions for the files in Windows. Consider when using CWND, only the default `nullPermissionManager` can be used.

Collaborative WND (CWND)::
Compared to a standard WND mountpoint, a collaborative WND mount offers enhanced features. In a CWND, each user shares the same ownCloud internal information for files and folders based on its internal identification (file_id). This means that _comments_ and _tags_ can be shared with all users accessing files and folders of this mount without the need that users must be members of the mount from an ownCloud point of view. A CWND can only be set by an admin in menu:Settings[Admin > Storage] but not in the users section. With CWND, all accessing users have their own access to the mount with their own credentials but share additional information with other users accessing the same data. See the table below to compare the differences.
+
.Collaborative WND Differences Based on the Mount Type
[cols=".^15%,.^35%,.^35%",options="header",caption=]
|===
|
^| Windows Network Drive
^| Windows Network Drive (collaborative)

h| Login Credentials
a| * User credentials +
* Credentials of the sharer
a| * `Log-in credentials, saved in session` +
* `Log-in credentials, saved in database` +
* `User entered, stored in database`

h| File ID
| Unique per user or from the sharer
| Same for all users accessing this mount

h| Access Rights
| From the accessing user or the sharer
| From the accessing user

h| Activities +
Comments +
Tags
a| * No shared access +
** Visibility limited to the user +
* Shared access +
** Comments and tags are shared, access based on the sharer
| Comments and tags are shared, access based on the user
|===

.More WND Properties
Mounts to a Windows or Samba file server are labeled with a little four-pane Windows-style icon, and the left pane of your Files page includes a Windows Network Drive filter. Figure 1 shows a new Windows Network Drive share marked with a red warning which indicates that ownCloud cannot connect to the share. The reason is that it may require the user to login, or it is not available, or there is an error in the configuration.

Files are synchronized bidirectionally, and you can create, upload and delete files and folders.
ownCloud server admins can create Windows Network Drive mounts and optionally allow users to set up their
own personal Windows Network Drive mounts.

Depending on the authentication method, passwords for each mount are encrypted and stored in the ownCloud
database, using a long random secret key stored in `config.php`. This allows ownCloud to access the shares
when the users who own the mounts are not logged in. This access will not work if the mount is session based, where passwords are not stored and are available only for the current active session.

.Figure 1. Windows Network Drive share on your Files page
image:enterprise/external_storage/windows_network_drive/wnd-1.png[Windows Network Drive share on your Files page, width=50%]

== Installation

Install the {oc-marketplace-url}/apps/windows_network_drive[External Storage: Windows Network Drives app]
from the ownCloud Market App or ownCloud Marketplace. To make it work, a few  dependencies have to be installed.

* A Samba client. This is included in all Linux distributions.
On Debian, Ubuntu, and other Debian derivatives it is called `smbclient`.
On SUSE, Red Hat, CentOS, and other Red Hat derivatives it is `samba-client`.
* `php-smbclient` (version 0.8.0+). It should be included in most Linux distributions.
You can use https://github.com/eduardok/libsmbclient-php[eduardok/libsmbclient-php],
if your distribution does not provide it.
* `which` and `stdbuf`. These should be included in most Linux distributions.

To install and configure the necessary packages, see the
xref:installation/manual_installation/manual_installation.adoc#prepare-your-server[Prepare Your Server]
section of the manual installation documentation.

TIP: For more information on SMB/CIFS in ownCloud, refer to the
xref:configuration/files/external_storage/smb.adoc[Samba file server configuration documentation].

TIP: If you encounter errors when using the WND app like `NT_STATUS_REVISION_MISMATCH`, please get in touch with support@owncloud.com.

[IMPORTANT]
====
ownCloud requires at least {samba-478-url}[Samba 4.7.8] or {samba-481-url}[Samba 4.8.1] on the
ownCloud server, when:

. The Windows Network Drive Listener is used; *and*
. The remote Windows/Samba file server requires at least {smb2-url}[version 2.0 of the SMB protocol].

The
xref:wnd-listener-setup[Windows Network Drive Listener] only supports version 1 of the SMB protocol (SMB1) with _earlier_ Samba versions.

*Background*

A {samba-url}[Samba] server, often a Microsoft Windows Server, can enforce the minimum and maximum protocol
versions used by connecting clients. However, in light of the
{wannacry-ransomware-attack-url}[WannaCry ransomware attack],
{msft-security-bulletin-ms17-010-url}[Microsoft patched Windows Server] to only allow SMB2 as minimum protocol by default, as SMB1 is insecure.

The ownCloud windows network drive listener utilizes the SMB notification feature which works well with
SMB1 in conjunction with most Samba versions. However, when the minimum protocol a server accepts is SMB2,
ownCloud requires Samba 4.7.8+ (4.8+ etc.) to be able to properly work, as prior versions of Samba had a
bug that broke this feature.
====

== Configuration

=== Enabling External Storage

To enable external storage, as the ownCloud administrator go to menu:Settings[Storage (in the admin section)]. Tick the checkbox to enable external storage.

=== Creating a New Share

.When you create a new WND share, you need multiple things:

* the login credentials for the share,
* the server address,
* the share name and
* the folder you want to connect to.

[CAUTION]
.Treat all the parameters as being case-sensitive.
====
Although some parts of the app might work properly regardless of casing, other parts might have problems
if the case is not respected.
====

.Follow this procedure to create a new mount point based on WND

. Enter the ownCloud mount point for your new WND share. This _must not_ be an existing folder.
. Select your authentication method. See xref:enterprise/external_storage/enterprise_only_auth.adoc[Enterprise-Only Authentication Options] for complete information on the available authentication methods.
+
.Figure 2. WND mountpoint and authorization credentials
image:enterprise/external_storage/windows_network_drive/wnd-2.png[WND mountpoint and authorization credentials, width=60%]
. Enter the address of the server that contains the WND share.
. The share name provided by Windows or Samba.
. The root folder of the share. This is can be a subfolder name, or the `$user` variable for the user's home directory. Note that the LDAP `Internal Username Attribute` must be set to the `samaccountname` for either the share or the root to work, and the user's home directory needs to match the `samaccountname`.
(See xref:configuration/user/user_auth_ldap.adoc[User Authentication with LDAP].)
. Login credentials.
. Select users or groups with access to the share. The default is all users.
. Click the gear icon for additional mount options. Note that previews are enabled by default, while
sharing is not (see Figure 3). Sharing is not available for all authorization methods. For details please see the
xref:enterprise/external_storage/enterprise_only_auth.adoc#authentication-option-details[Enterprise-Only Authentication Options]. When using large storages with many files, you may want to disable previews, because this can significantly increase performance.
+
.Figure 3. WND server, credentials, and additional mount options
image:enterprise/external_storage/windows_network_drive/wnd-3.png[WND server, credentials, and additional mount options, width=50%]

Your changes are saved automatically.

NOTE: When you create a new mountpoint using login credentials (session based), you must log out of ownCloud and then log back in so you can access the share. You only have to do this the first time.

=== Permission Manager

Starting with version 1.0.1 of the Windows Network Drives App {acl-url}[Access Control Lists (ACLs)] are supported. To obtain the ACL information, two ACL providers can be selected:

- xref:the-null-permission-manager[The Null Permission Manager]
- xref:the-owncloud-ldap-permission-manager[The ownCloud LDAP Permission Manager]

image::enterprise/external_storage/windows_network_drive/acl-permissions-manager.png[Configuring ACL retrieval in the ownCloud Windows Network Drive app.]

On standard deployments, you don't need to change anything. Just leave the field empty and the default `nullPermissionManager` permission manager will be used.

Regardless of which provider you choose, an ownCloud administrator should run a
xref:configuration/server/occ_command.adoc#file-operations[files:scan], manually, after changing the configuration, to update the permissions correctly. Otherwise, the permissions shown by ownCloud might be incorrect.

NOTE: Permissions are only auto-updated if there has been a change in the files.

==== The Null Permission Manager

The `Null Permission Manager` is the default permission manager for ACLs and is used, if no other ACL
manager is specified. This is also the case, when no permission is explicitly set. If you want to retain
ownCloud's current behaviour, then use this permission manager. When in effect, the Windows Network Drive
app uses the file's attributes (e.g., read-only, and hidden), to determine how the user can interact with
the file. There are no usage restrictions.

The value to select for this provider is: `nullPermissionManager`.

==== The ownCloud LDAP Permission Manager

The ownCloud LDAP Permission Manager evaluates ACLs in files along with file attributes to determine the permissions. In order to evaluate the ACLs, it needs access to the user and group membership information of the target Windows or Samba server. Therefore it uses ownCloud's {oc-marketplace-url}/apps/user_ldap[LDAP Integration app] for this.

IMPORTANT: Both the Windows (or Samba) server and ownCloud's LDAP Integration app must connect to the same Active Directory server so that ownCloud can retrieve the same user and group information.

The use of this provider requires two key things:

- An Active Directory server which contains the standard user and group information that can be used by the {oc-marketplace-url}/apps/user_ldap[LDAP Integration app].
- ownCloud's LDAP Integration app to be xref:configuration/user/user_auth_ldap.adoc[correctly configured] to retrieve user and group information from the same Active Directory / LDAP server as the one that the Windows or Samba server uses.

IMPORTANT: The ownCloud LDAP Integration app must configure the `sAMAccountName` to be the ownCloud server's username.

[TIP]
====
Some groups, such as `everyone` might not be handled properly.
This is because such groups don't exist in the LDAP server, or might not be found if the domain is
different, such as `nt authority\system` or `builtin\domain-users`.
====

The value to select for this provider is: `ocLdapPermissionManager`.

=== WND Notifications

The SMB protocol supports registering for notifications of file changes on remote Windows SMB storage servers. Notifications are more efficient than polling for changes, as polling requires scanning the whole mounted SMB storage. While files changed through the ownCloud Web Interface or sync clients are automatically recognized by ownCloud, recognition is not possible when files are changed directly on remote SMB storage mounts. When using the _listener_, files changed on the SMB backend are recognized and a notification is stored in the database. The _process-queue_ job reads these stored notifications and initiates further actions.

NOTE: The capability of the listener depends on the ability of the used SMB/CIFS storage backend to provide notifications. While Windows file servers have no limitations, some vendors may have restrictions. Please check these with your storage provider. It may be possible, that notifications for Samba only work for the target folder you're listening to, but not for any sub structures. If you're listening on the "/top" folder, you may not receive notifications for "/top/middle/bottom" folder. In this case, you have to setup listeners for every _existing_ folder and also for any _new_ folders that will be created. With Windows file servers, you will receive notifications for every file or subfolder inside the folder you're listening to.

==== WND Listener Setup

The WND listener for ownCloud 10 includes two different commands that need to be executed:

* xref:wndlisten[wnd:listen] Listen to changes and save them in the database
* xref:wndprocess-queue[wnd:process-queue] Process saved listener changes from the database 

===== wnd:listen

This command listens to changes for each  host and share configured and stores all notifications gathered in the database. _It is intended to run this command as a service_. The command requires the Windows/Samba account and the host/share the listener will listen to. The command does not produce any output by default, unless an error happens. Each stored notification will be further processed by the `wnd:process-queue` and will be removed from the database after processing.

NOTE: You can increase the command's verbosity by using `-vvv`. Doing so displays the listeners activities including a timestamp and the notifications received. A _read-only_ permission for the used account should be enough, but may need to be increased.

The simplest way, useful for initial testing is, to start the `wnd:listen` process manually, as follows:

[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen <host> <share> <username>
----

The password is an optional parameter and you will be asked for it if you didn't provide it as in the example above. In order to start `wnd:listen` without any user interaction like as service, provide the password from a password file.

[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen <host> <share> <username> \
     --password-file=/my/secret/password/file \
     --password-trim
----

For additional options to provide the password, check xref:password-options[Password Options]

Note that the password must be in plain text inside the file. Neither spaces nor newline characters will be removed from the contents of the file by default, unless the `--password-trim` option is added. The password file must be readable by the apache user (or www-data). Also make sure that the password file is outside of any directory handled by apache (web-readable) for security reasons. You may use the same location when using flock in xref:execution-serialization[Execution Serialization] below.

You should be able to run any of those commands, and/or wrap them into a systemd service or any other
startup service, so that the `wnd:listen` command is automatically started post booting.

===== wnd:process-queue

This command processes the stored notifications for a given host and share. This process is intended to
be run periodically as a Cron job, or via a similar mechanism. The command will process the notifications
stored by the `wnd:listen` process, showing only errors by default. If you need more information, increase
the verbosity by calling `wnd:process-queue -vvv`.

As a simple example, you can check the following:

[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:process-queue <host> <share>
----

You can run that command, even if there are no notifications to be processed.

Depending on your requirements, you can wrap that command in a Cron job so it's run every 5 minutes for example.

==== WND Listener Service Configuration

Create a service for `systemd` following the instructions below that checks for processable notifications:

[NOTE]
====
* Replace the all upper case words `SERVER`, `SHARE`, `USER` and `PASSWORD` in both, the **filename** and in the **contents** below with their respective values.
* Take care to also adjust the paths in `WorkingDirectory` and `ExecStart` according to your installation.
====

* For each WND mount point distinguished by a SERVER - SHARE pair:
** Create a file for each `SERVER-SHARE` pair named `owncloud-wnd-listen-SERVER-SHARE.service` and locate it in `/etc/systemd/system/`
** Password: For security reasons, create a file readable only by `www-data` and outside the directories handled by apache (let's suppose in /opt/mypass). The file must contain only the password for the share. In this example our file is: "/opt/mypass". The listener will read the contents of the file and use them as the password for the account. This way, only root and the apache user should have access to the password.
** `--password-trim` removes blank characters from the password file added by 3rdparty software or other services.
+
----
[Unit]
Description=ownCloud WND Listener for SERVER SHARE
After=syslog.target
After=network.target
Requires=apache2.service
[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/owncloud
ExecStart=/usr/bin/php ./occ wnd:listen -vvv SERVER SHARE USER --password-file=/opt/mypass --password-trim
Type=simple
StandardOutput=journal
StandardError=journal
SyslogIdentifier=%n
KillMode=process
RestartSec=3
Restart=always
[Install]
WantedBy=multi-user.target
----

* Run the following command, once for each created file:
+
[source,console]
----
sudo systemctl daemon-reload
sudo systemctl enable owncloud-wnd-listen-SERVER-SHARE.service
sudo systemctl start  owncloud-wnd-listen-SERVER-SHARE.service
----

* To list all systemd wnd listeners for ownCloud run the following command, assuming you use the naming convention described above:
+
[source,console]
----
systemctl list-units | grep owncloud-wnd-listen
----

* Please re-run the following commands if you are changing the contents of a particular listener service:
+
[source,console]
----
sudo systemctl daemon-reload
sudo systemctl restart owncloud-wnd-listen-SERVER-SHARE.service
----

For more information about configuring services for systemd, read  
{manage-systemd-services-url}[How To Use Systemctl to Manage Systemd Services and Units]

==== WND Process Queue Configuration

Create or add a `crontab` file in `/etc/cron.d/oc-wnd-process-queue`.

NOTE: The commands must be **strictly sequential**. This can be done by using `flock -n` and tuning the `-c` (chunk-size) parameter of `occ wnd:process-queue`, see the xref:configuration/server/occ_command.adoc#windows-network-drive-wnd[wnd occ commands] description and the  xref:execution-serialization[Execution Serialization] below.

* Make a `crontab` entry to run a script iterating over all `SERVER SHARE` pairs with an appropriate `occ wnd:process-queue` command.
+
[source,console]
----
* * * * *  sudo -u www-data /usr/bin/php /var/www/owncloud/occ wnd:process-queue <HOST> <SHARE>
----

===== Execution Serialization

Parallel runs of `wnd:process-queue` might lead to a user lockout. The reason for this is that several
`wnd:process-queue` might use the same wrong password because it hasn't been updated by the time they fetch it.

It's recommended to force the execution serialization of the `wnd:process-queue` command. You might want to
use {anacron-examples}[Anacron], which seems to have an option for this scenario, or wrap the command with
{shell-flock-intro}[flock].

If you need to serialize the execution of the `wnd:process-queue`, check the following example with
{shell-flock-intro}[flock]

[source,console,subs="attributes+"]
----
flock -n /opt/my-lock-file {occ-command-example-prefix} wnd:process-queue <host> <share>
----

In that case, flock will try to get the lock of that file and won't run the command if it isn't possible. For
our case, and considering that file isn't being used by any other process, it will run only one
`wnd:process-queue` at a time. If someone tries to run the same command a second time while the previous
one is running, the second will fail and won't be executed.

The lock file `/opt/my-lock-file` itself will be created as an empty file by the `flock` command if it does not yet exist, but after it has been created the lock file doesn't change. Only an flock will be applied and removed. The file won't be removed after the script completes.

You can use flock also in cron, see the example below:

[source,console,subs="attributes+"]
----
* * * * *  flock -n /opt/my-lock-file -c 'sudo -u www-data /usr/bin/php /var/www/owncloud/occ wnd:process-queue <HOST> <SHARE>'
----

Check {flock-docs-url}[flock's documentation] for details and more options.

=== Activity Extension

From version 2.0.0 the Windows Network Drive app includes an extension of the Activity app. This extension will allow the app to send events to the Activity app so the users know what happened in the Windows Network Drive storage.

Please see Figure 4 how a notification can look like. In this example, one user accessing the same host/share has changed a file. Other users will now get an activity notification about this change.

.Figure 4. Activity Notification for a Changed File
image:enterprise/external_storage/windows_network_drive/activity_file_change_notification.png[Activity notification for a Changed File]

This extension requires the following components:

* `wnd:listen` command set up and running in order to get the storage events
* `wnd:process-queue` command running periodically (or manually) over the event queues generated by the `wnd:listen` command
* The Activity app enabled

For setting up the `wnd:listen` and `wnd:process-queue` commands, see their respective sections above.

This extension is disabled by default. This means that no activity will reach the users. In order to enable this extension, you can edit the `config/config.php` file and add the following configuration:

[source,php]
----
'wnd.activity.registerExtension' => true,
----

NOTE: This configuration will affect all the WND mount points

The events that will be shown to the users are based on what the `wnd:process-queue` detects and changes in the ownCloud's FS. Since the command includes some optimizations, some events might be inaccurate in some scenarios. For example, if multiple files are added in the same folder, there won't be multiple "file added" events but only one "folder modified" in the parent folder.

The events are expected to reach only to the affected users. This filters out the users who cannot access the mount point, and also the users who do not have enough permissions in the Network Drive (Windows, Samba) to access that file.

As part of the Activity app configuration, users can decide which events they want to be notified about and how, in the activity stream or via email.

Users who can access the Windows Network Drive storage via share won't receive activity notifications by default. You can add the following configuration in the `config/config.php` file to enable sending the activity notification to those users.

[source,php]
----
'wnd.activity.sendToSharees' => true,
----

NOTE: `wnd.activity.sendToSharees` key depends on the `wnd.activity.registerExtension` key to take effect.

=== Collaborative WND

CWND can only be set by an admin in menu:Settings[Admin > Storage]. This mount type cannot be selected by users in the user section. To prepare access for your mount point using the CWND mount type, you must provide a _Service Account_ (SA) which is an ordinary SMB user granting read access to the share you want to mount. You can use one SA for all CWND mounts or separate ones. The SA is used to gather the contents of a share used by the WND Listener and provides a common `file_id` to all accessing users, while the accessing users can only access those files and folders for which they've been granted rights.

. As an admin, go to menu:Settings[Admin > Storage] and create a new CWND based mount point.
+
.Figure 5. Add a Collaborative Windows Network Drive Mount
image:enterprise/external_storage/windows_network_drive/cwnd_add_storage.png[Add Collaborative Windows Network Drive Mount, width=50%]
. Chose any name for the mount point that fits your needs.
. Select user login type.
+
[IMPORTANT]
====
The following three are sensible and working selections for CWND:
[loweralpha]
. `Log-in credentials, saved in session`
. `Log-in credentials, saved in database`
. `User entered, stored in database` ^[1]^
+
[1] Must be used if user authentication is made with OIDC
====
+
.Figure 6. Select How User Logs in to the Mount Point
image:enterprise/external_storage/windows_network_drive/cwnd_login_possibilities.png[Select How User Logs Into the Mount Point]
[loweralpha]
.. `Log-in credentials, saved in session`
+
When the user logs in to ownCloud via a browser, the credentials to authenticate CWND are taken from this login. These credentials immediately end when the user logs out because the session has ended.
+
* _This login type can not be set to `Enable Sharing`._
* _This login type is by design not compatible with OIDC authentication._
.. `Log-in credentials, saved in database`
+
Similar to `Log-in credentials, saved in session`, the credentials to authenticate CWND are taken from the login but saved in the ownCloud database. Any re-login also updates the database entry. As the credentials to access CWND are taken from the database, a user logout will not stop CWND access and serving data is continued, e.g. for synchronization.
+
* _This login type can be set to `Enable Sharing`._
* _This login type is by design not compatible with OIDC authentication._
.. `User entered, stored in database`
+
User login to ownCloud and providing credentials to access the CWND mount are completely separated. After logging in to ownCloud, the user may see his CWND mounts marked inaccessible. To regain access, the user must enter his share credentials in menu:Settings[Personal > Storage] which are then stored into the ownCloud database. As the credentials to access CWND are taken from the database, a user logout will not stop CWND access and serving data is continued, e.g. for synchronization.
+
* _This login type can be set to `Enable Sharing`._
* _This login type is by design *the only one compatible with OIDC authentication*._
+
.Figure 7. Re-enter Mount Access Credentials
image:enterprise/external_storage/windows_network_drive/cwnd_regain_mount_access.png[Re-enter Mount Access Credentials]

. Configure this mount point by adding required data into the corresponding fields
+
.Figure 8. Enter Connection Info and the Service Account
image:enterprise/external_storage/windows_network_drive/cwnd_fields.png[Enter Connection Info and Service Account]
+
NOTE: Starting with ownCloud 10.8, you can properly enter the correct password without using the deprecated occ command `wnd:set-service-account`, as the security measures have been improved and all fields in the mount settings marked as _password_ are now encrypted from the beginning by default. Existing settings are automatically migrated when upgrading.
+
When everything has been entered correctly, the mount point gets a green button on the left.

== Troubleshooting

=== General or Connectivity Issues

If you encounter issues using Windows network drive, then try the following troubleshooting steps:

First check the connection to the share by using {smbclient-manpage-url}[smbclient] on the command line
of the ownCloud server. Here is an example:

[source,console,subs="attributes+"]
----
smbclient -U Username -L //Servername
----

Take the example of attempting to connect to the host MyHost, the share named `MyData` using `occ wnd:listen` replacing user and password accordingly. Running the following command would work:

[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen MyHost MyData user password
----

NOTE: The command is case-sensitive, and that it must match the information from the mount point configuration.

=== libsmbclient Issues

If your Linux distribution ships with `libsmbclient 3.x`, which is included in the Samba client, you may
need to set up the `HOME` variable in Apache to prevent a segmentation fault. If you have
`libsmbclient 4.1.6` and higher, it doesn't seem to be an issue, so you won't have to change your `HOME`
variable. To set up the `HOME` variable on Ubuntu, modify the `/etc/apache2/envvars` file:

----
unset HOME
export HOME=/var/www
----

In Red Hat/CentOS, modify the `/etc/sysconfig/httpd` file and add the following line to set the HOME
variable in Apache:

----
export HOME=/usr/share/httpd
----

By default, CentOS has activated SELinux, and the `httpd` process can not make outgoing network connections.
This will cause problems with the `curl`, `ldap` and `samba` libraries.  You'll need to get around this
to make this work. First, check the status:

[source,console]
----
getsebool -a | grep httpd
httpd_can_network_connect --> off
----

Then enable support for network connections:

[source,console]
----
setsebool -P httpd_can_network_connect 1
----

In openSUSE, modify the `/usr/sbin/start_apache2` file:

[source,console]
----
export HOME=/var/lib/apache2
----

Restart Apache, open your ownCloud Admin page and start creating SMB/CIFS mounts.

=== Basic Setup for One ownCloud Server

. Go to the admin settings and set up the required WND mounts. Be aware though, that there are some
limitations. These are:
.. ownCloud needs access to the Windows account password for the mounts to update the file cache properly.
This means that "__login credentials, saved in session__" won't work with the listener.
ownCloud suggests to use "__login credentials, saved in DB__" as the best replacement instead.
.. The `$user` placeholder for the share name, such as `//host/$user/path/to/root`, providing a share which is accessible per/user won't work with the listener. This is because the listener won't scale, as you'll need to setup one listener per/share equals one listener per user. As a result, you'll end up with too many listeners. An alternative is, to provide a common share for the users and use the `$user` placeholder in the root, such as `//host/share/$user/folder`.
. Start the `wnd:listen` process if it's not already started, ideally running it as a service.
If it isn't running, no notification are stored. The listener stores the notifications. Any change in the
mount point configuration, such as adding or removing new mounts, and logins by new users, won't affect
the behavior, so there is no need to restart the listener in those cases.
+
In case you have several mount point configurations, note that each listener attaches to one host and share.
If there are several mount configurations targeting different shares, you'll need to spawn one listener
for each. For example, if you have one configuration with `10.0.0.2/share1` and another with
`10.0.0.2/share2`, you'll need to spawn 2 listeners, one for the first configuration and another for the
second.
. Run the `wnd:process-queue` periodically, usually via
xref:configuration/server/background_jobs_configuration.adoc#cron-jobs[a Cron job].
The command processes all the stored notifications for a specific host and share. If you have several,
you could set up several Cron jobs, one for each host and share with different intervals, depending on the
load or update urgency. As a simple example, you could run the command every 2 minutes for one server
and every 5 minutes for another.

As said, the command processes all the stored notifications, squeeze them and scan the resulting folders.
The process might crash if there are too many notifications, or if it has too many storages to update. The
`--chunk-size` option will help by making the command process all the notifications in buckets of that size.

On the one hand the memory usage is reduced, on the other hand there is more network activity. We recommend
using the option with a value high enough to process a large number of notifications, but not so large to
crash the process. Between 200 and 500 should be fine, and we'll likely process all the notifications in one go.

=== Password Options

There are several ways to supply a password:

. Interactively in response to a password prompt.
+
[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen <host> <share> <username>
----
. Sent as a parameter to the command.
+
[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen <host> <share> <username> <password>
----
. Read from a file, using the `--password-file` switch to specify the file to read from. Note, that the
password must be in plain text inside the file, and neither spaces nor newline characters will be removed
from the file by default, unless the `--password-trim` option is added. The password file must be readable
by the apache user (or www-data)
+
[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen <host> <share> <username> \
     --password-file=/my/secret/password/file
----
+
[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen <host> <share> <username> \
     --password-file=/my/secret/password/file \
     --password-trim
----
+
NOTE: If you use the `--password-file` switch, the entire contents of the file will be used for the
password, so please be careful with newlines.
+
IMPORTANT: If using `--password-file` make sure that the file is only readable by the apache /
www-data user and inaccessible from the web. This prevents tampering or leaking of the information.
The password won't be leaked to any other user using `ps`.
. Using 3rd party software to store and fetch the password. When using this option, the 3rd party app
needs to show the password as plaintext on standard output.

=== Reduce WND Notifier Memory Usage

The WND in-memory notifier for password changes provides the ability to notify all _affected_ WND storages to reset their passwords. This feature is intended to prevent a password lockout for the user in the backend. However, this functionality _can_ consume a significant amount of memory. To disable it, add the following configuration to your `config/config.php.`:

[source,php]
----
'wnd.in_memory_notifier.enable' => false,
----

NOTE: The password will be reset on the next request, regardless of the flag setting.

=== 3rd Party Software Examples

Third party password managers or processes can be integrated. The only requirement is that they have to provide the password in plain text somehow. If not, additional operations might be required to get the password as plain text and inject it in the listener.

==== plainpass

This provides a bit more security because the `/tmp/plainpass` password as shown below should be owned by root and only root should be able to read the file (0400 permissions); Apache, particularly, shouldn't be able to read it. It's expected that root will be the one to run this command.

[source,console,subs="attributes+"]
----
cat /tmp/plainpass | {occ-command-example-prefix} wnd:listen <host> <share> <username> --password-file=-
----

==== base64

Similar to plainpass, the content in this case gets encoded in the {base64-url}[Base64 format]. There's not much security, but it has additional obfuscation.

[source,console,subs="attributes+"]
----
base64 -d /tmp/encodedpass | \
   {occ-command-example-prefix} wnd:listen <host> <share> <username> --password-file=-
----

==== pass

Example using "pass"

* You can go through {pass-url}[manage passwords from the command line] to set up the keyring for whoever will fetch the password (probably root) and then use something like the following:

[source,console,subs="attributes+"]
----
pass the-password-name | {occ-command-example-prefix} wnd:listen <host> <share> <username> --password-file=-
----

==== HashiCorp Vault

This example uses {vaultproject-url}[Vault] as the secrets store. See {hashicorp-url}[HCP Vault] on how to setup the secrets store. Then use something like the following:

[source,console,subs="attributes+"]
----
vault kv get -field=password secret/samba | {occ-command-example-prefix} wnd:listen <host> <share> <username> --password-file=-
----

Use Vault's ACLs to limit access to the token. Destroy the token after starting the service during boot with systemd.

=== Password Option Precedence

If both the argument and the option are passed, e.g.,
[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen <host> <share> <username> <password> --password-file=/tmp/pass`
----
then the `--password-file` option will take precedence.

=== Optimizing wnd:process-queue

NOTE: Do not use this option if the process-queue is fast enough. The option has some drawbacks,
specifically regarding password changes in the backend.

`wnd:process-queue` creates all the storages that need to be updated from scratch. To do so, we need to
fetch all the users from all the backends (currently only the ones that have logged in at least once
because the others won't have the storages that we'll need updates).

To optimize this, `wnd:process-queue` make use of two switches: `–serializer-type` and `–serializer-param`.
These serialize storages for later use, so that future executions don't need to fetch the users, saving
precious time — especially for large organizations.

[cols="30%,100%",options="header",]
|===
| Switch | Allowed Values
| `--serializer-type` | `file`. Other valid values may be added in the future, as more
implementations are requested.
| `--serializer-param`
| Depends on `--serializer-type`, because those will be the parameters that the chosen serializer will use.
For the `file` serializer, you need to provide a file location in the host FS where the storages will be serialized.
You can use `--serializer-param file=/tmp/file` as an example.
|===

While the specific behavior will depend on the serializer implementation, the overall behavior can be
simplified as follows:

If the serializer's data source (such as _a file_, _a database table_, or some _Redis keys_) has storage
data, it uses that data to create the storages; otherwise, it creates the storages from scratch.

After the storages are created, notifications are processed for the storages. If the storages have been
created from scratch, those storages are written in the data source so that they can be read on the next run.

NOTE: It's imperative to periodically clean up the data source to fetch fresh data, such as for
new storages and updated passwords. There isn't a generic command to do this from ownCloud, because it
depends on the specific serializer type. Though this option could be provided at some point if requested.

=== The File Serializer

The file serializer is a serializer implementation that can be used with the `wnd:process-queue` command.
It requires an additional parameter where you can specify the location of the file containing the
serialized storages.

There are several things you should know about this serializer:

* The generated file contains the encrypted passwords for accessing the backend. This is necessary in order
to avoid re-fetching the user information, when next accessing the storages.
* The generated file is intended to be readable and writable *only* for the web server user. Other users
shouldn't have access to this file. Do not manually edit the file. You can remove the file if it contains
obsolete information.

=== Usage Recommendations

==== Number of Serializers

Only one file serializer should be used per server and share, as the serialized file has to be per server
and share. Consider the following usage scenario:

* If you have three shares: `10.0.2.2/share1`, `10.0.2.2/share2`, and
`10.0.10.20/share2`, then you should use three different calls to
`wnd:process-queue`, changing the target file for the serializer for each one.

Since the serialized file has to be per server and share, the serialized file has some checks to prevent
misuse. Specifically, if we detect you're trying to read the storages for another server and share from the
file, the contents of the file won't be read and will fallback to creating the storage from scratch. At
this point, we'll then update the contents of that file with the new storage.

Doing so, though, creates unneeded competition, where several process-queue will compete for the serializer
file. For example, let's say that you have two process-queues targeting the same serializer file. After the
first process creates the file the second process will notice that the file is no longer available. As a
result, it will recreate the file with new content.

At this point the first process runs again and notices that the file isn't available and recreate the file
again. When this happens, the serializer file's purpose isn't fulfilled As a result, we recommend the use
of a different file per server and share.

==== File Clean Up

The file will need to cleaned up from time to time. The easiest way to do this is to remove the file when
it is no longer needed. The file will be regenerated with fresh data the next execution if the serializer
option is set.

=== Interaction Between Listener and Windows Password Lockout

Windows supports {password-lockout-policies-url}[password lockout policies].
If one is enabled on the server where an ownCloud share is located, and a user fails to enter their
password correctly several times, they may be locked out and unable to access the share.

//https://github.com/owncloud/Windows_network_drive/issues/94 [known issue]

This is a known issue that prevents these two inter-operating correctly. Currently, the only viable solution is to ignore that feature and use the `wnd:listen` and `wnd:process-queue`, without the serializer options.

=== Multiple Server Setup

Setups with several servers might have some difficulties in some scenarios:

* The `wnd:listen` component _might_ be duplicated among several servers. This shouldn't cause a problem,
depending on the limitations of the underlying database engine. The supported database engines should be
able to handle concurrent access and de-duplication.
* The `wnd:process-queue` _should_ also be able to run from any server, however limitations for concurrent
executions still apply. As a result, you might need to serialized command execution of the
`wnd:process-queue` among the servers (to avoid for the password lockout), which might not be possible or
difficult to achieve. You might want to execute the command from just one specific server in this case.
* `wnd:process-queue` + serializer. First, check the above section to know the interactions with the
password lockout. Right now, the only option you have to set it up is to store the target file in a common
location for all the server. We might need to provide a specific serializer for this scenario
(based on Redis or DB)

=== Basic Command Execution Examples

[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen host share username password

{occ-command-example-prefix} wnd:process-queue host share

{occ-command-example-prefix} wnd:process-queue host share -c 500

{occ-command-example-prefix} wnd:process-queue host share -c 500 \
     --serializer-type file \
     --serializer-param file=/opt/oc/store

{occ-command-example-prefix} wnd:process-queue host2 share2 -c 500 \
     --serializer-type File \
     --serializer-param file=/opt/oc/store2
----

To set it up, make sure the listener is running as a system service:

[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:listen host share username password
----

Setup a Cron job or similar with something like the following two commands:

[source,console,subs="attributes+"]
----
{occ-command-example-prefix} wnd:process-queue host share -c 500 \
     --serializer-type file \
     --serializer-param file=/opt/oc/store1

sudo rm -f /opt/oc/store1 # With a different schedule
----

The first run will create the `/opt/oc/store1` with the serialized storages, the rest of the executions will use that file. The second Cron job, the one removing the file, will force the `wnd:process-queue` to
refresh the data.

It's intended to be run in a different schedule, so there are several executions of the `wnd:process-queue` fetching the data from the file. Note that the file can be removed manually at any time if it's needed (for example, in case the admin has reset some passwords or has been notified about password changes).

=== Performance on High Number of ACL Targeting Users

The WND app doesn’t know about the users or groups associated with ACLs. This means that an ACL containing "admin" might refer to a user called "admin" or a group called "admin". By default, the group membership component considers the ACLs to target groups, and as such, it will try to get the information for such a group. This works fine if the majority of the ACLs target groups. If the majority of the ACLs contain users, this might be problematic. The cost of getting information on a group is usually higher than getting information on a user. This option makes the group membership component assume the ACL contains a user and checks whether there is a user in ownCloud with such a name first. If the name doesn’t refer to a user, it will get the group information. Note that this will have performance implications if the group membership component can’t discard users in a large number of cases. It is recommended to enable this option only if there are a high number of ACLs targeting users. In order to enable this setting, you can edit the `config/config.php` file and add the following configuration:

[source,php]
----
'wnd.groupmembership.checkUserFirst' => true,
----
