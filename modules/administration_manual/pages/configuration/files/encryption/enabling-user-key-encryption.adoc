= User-Key Based Encryption

== User-Key Based Encryption Limitations

* Users added to groups cannot decrypt files on existing shares.
* OnlyOffice will not work.
* Impersonate will not work.
* OAuth2 does will not work.
* Elasticsearch will not work.
* Users getting access to an external storage which already contains existing encrypted files cannot get access to said files for reasons such as the group case above.
* When having data shared with a group and group membership changes after the share is established, subsequently added users will not be able to open the shared data unless the owner will share it again.

== Enabling User-Key based Encryption

To be safe, first put your server in single user mode, to avoid any issues on a running instance, using the following command:

[source,console]
....
sudo -u www-data php occ maintenance:singleuser --on
....

Then, enable the default encryption module app, using the following command:

[source,console]
....
sudo -u www-data php occ app:enable encryption
....

After that, enable encryption, using the following command:

[source,console]
....
sudo -u www-data php occ encryption:enable
....

Then, enable the user-key, using the following command:

[source,console]
....
sudo -u www-data php occ encryption:select-encryption-type user-keys
....

Finally, encrypt all data, using the following command:

[source,console]
....
sudo -u www-data php occ encryption:encrypt-all
....

Now you can turn off the single user mode:

[source,console]
....
sudo -u www-data php occ maintenance:singleuser --off
....

[[how-to-enable-users-file-recovery-keys]]
== How To Enable Users File Recovery Keys

Once a user has encrypted their files, if they lose their ownCloud password, then they lose access to their encrypted files, as their files will be unrecoverable. 
It is not possible, when user files are encrypted, to reset a user’s password using the standard reset process.

If so, you’ll see a yellow banner warning:

""
Please provide an admin recovery password; otherwise, all user data will be lost.
""

To avoid all this, create a Recovery Key. 
To do so, go to the Encryption section of your Admin page and set a recovery key password.

image:configuration/files/encryption10.png[image]

You then need to ask your users to opt-in to the Recovery Key. For the
users to do this, they need to go to the ``**Personal**'' page and
enable the recovery key. This signals that they are OK that the admin
might have a way to decrypt their data for recovery reasons. If they do
_not_ do this, then the Recovery Key won’t work for them.

image:configuration/files/encryption7.png[image]

For users who have enabled password recovery, give them a new password
and recover access to their encrypted files, by supplying the Recovery
Key on the Users page.

image:configuration/files/encryption8.png[image]

You may change your recovery key password.

image:configuration/files/encryption12.png[image]

[NOTE]
====
Sharing a recovery key with a user group is *not* supported.
This is only supported with xref:create-a-new-master-key[the master key].
====

[[changing-the-recovery-key-password]]
== Changing The Recovery Key Password

If you have misplaced your recovery key password and need to replace it, here’s what you need to do:

1. Delete the recovery key from both `data/owncloud_private_keys` and
   `data/public-keys`
2. Edit your database table `oc_appconfig` and remove the rows with the
   config keys `recoveryKeyId` and `recoveryAdminEnabled` for the appid
   `files_encryption`
3. Login as admin and activate the recovery key again with a new
   password. This will generate a new key pair
4. All users who used the original recovery key will need to disable it
   and enable it again. This deletes the old recovery share keys from their
   files and encrypts their files with the new recovery key

NOTE: You can only change the recovery key password if you know the original. This is by design, as only admins who know the recovery key password should be able to change it. If not, admins could hijack the recovery key from each other

[IMPORTANT]
====
Replacing the recovery key will mean that all users will lose the possibility to recover their files until they have applied the new recovery key.
====

[[decrypt-user-key-encryption]]
== Decrypt User-Key Encryption

You must first put your ownCloud server into single-user mode, to prevent any user activity until encryption is completed.

[source,console]
....
sudo -u www-data php occ maintenance:singleuser --on
Single user mode is currently enabled
....

include::sharing-encrypted-files.adoc[leveloffset=+1]
